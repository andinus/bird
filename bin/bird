#!perl6

use Bird;
use Sparrow6::DSL;
use Sparrow6::Task::Repository;
use Bird::DSL::File;
use Bird::DSL::Directory;
use Bird::DSL::Command;

sub MAIN (

  Bool :$verbose = False, 
  Str  :$host,
  Str  :$user,
  Str  :$password,
  Str  :$rules = "rules.pl6",

)

{
  my @hosts;

  if $host {
    if $host.IO ~~ :f {
      log("read host from file", $host);
      @hosts = EVALFILE "hosts.pl6";
    } else {
        log("read host from command line", $host);
        @hosts = $host;
    }
  } elsif "hosts.pl6".IO ~~ :f {
    log("read hosts from file", "hosts.pl6");
    @hosts = EVALFILE "hosts.pl6";
  } else {
      die "need host(s)"
  }

  log("cmd file", cmd-file());
  log("check file", state-file());

  EVALFILE $rules;

  Sparrow6::Task::Repository::Api.new.index-update();

  task-run "check my hosts", "ssh-bulk-check", %(
    cmd => cmd-file(),
    state => state-file(),
    hosts => @hosts,
    user => $user,
    password => $password,
  );

}
